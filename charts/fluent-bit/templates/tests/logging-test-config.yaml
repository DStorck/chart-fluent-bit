apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "fullname" . }}
  labels:
    app: {{ template "name" . }}
    chart: {{ template "namewithversion" . }}
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
data:
  run.sh: |-
    MAX_ATTEMPTS=5

    @test "Test that every input plugin has produced at least one record." {

        INVALID=0
        # Get initial health code
        healthCode=${INVALID}

        until [ "${healthCode}" -gt "${INVALID}" ]; do
          healthCode=$(curl -s --connect-timeout 1 \
            -o /dev/null \
            -w %{http_code} \
            --location \
              http://{{ template "name" . }}.{{ .Release.Namespace }}:2020/api/v1/metrics)

          # sleep for a 3 sec if failed
          if [ "${healthCode}" -eq "${INVALID}" ]; then
            echo "Will retry, result is ${healthCode}"
            sleep 3;
          fi

        echo "healthcode returned from fb curl check was: $healthCode"
        done

        while [[ $ATTEMPTS -lt $MAX_ATTEMPTS ]]
        do
          resp="$(curl -s http://{{ template "name" . }}.{{ .Release.Namespace }}:2020/api/v1/metrics)"

          if [[ "$resp" == "" ]
          then
            echo "$ATTEMPT/$MAX_ATTEMPT: curl response was nil."
            continue
          fi

          result="$(echo "$resp" | jq '[(.input[].records | select(. == 0)) ] | length')"

          echo "$ATTEMPTS/$MAX_ATTEMPTS: \$result from jq on curl-check for metrics records was: '$result'"

          ((ATTEMPTS++))
        done

        [ "$result" -eq 0 ]
    }
